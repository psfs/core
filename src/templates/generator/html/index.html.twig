<?php
defined('PSFS_START_TS') or define('PSFS_START_TS', microtime(true));
defined('PSFS_START_MEM') or define('PSFS_START_MEM', memory_get_usage(true));
/**
 * PSFS Front Controller (Autogenerated {{ ""|date("Y-m-d H:i:s") }})
 *
 * Responsibilities:
 *  - Reject direct access to static files (when not served by web server).
 *  - Load the PSFS bootstrap (PHAR or vendor mode).
 *  - Execute the Dispatcher to run the application.
 */

// -----------------------------------------------------------------------------
// 1. Block direct access to static files
// -----------------------------------------------------------------------------

$requestUri = $_SERVER['REQUEST_URI'] ?? '';

/**
 * If the URL looks like a direct file request (e.g. /foo.js, /bar.png, /style.css),
 * we return a 404 here because the server did not serve the file itself.
 *
 * This fallback is mainly for the PHP built-in server or misconfigured web servers.
 */
if (preg_match('/\.[a-zA-Z0-9]{2,10}$/', $requestUri)) {
    header('HTTP/1.0 404 Not Found');
    exit('File ' . $requestUri . ' not found');
}


// -----------------------------------------------------------------------------
// 2. Locate and load the PSFS bootstrap (PHAR or vendor mode)
// -----------------------------------------------------------------------------

$projectRoot = realpath(__DIR__ . '/..');
$pharPath    = $projectRoot . '/psfs.phar';
$vendorAutoload = $projectRoot . '/vendor/autoload.php';

if (file_exists($vendorAutoload)) {
    // Normal Composer installation
    require_once $vendorAutoload;
    require_once $projectRoot . '{% if PSFS_AS_VENDOR %}/vendor/psfs/core{% endif %}/src/bootstrap.php';
} else {
    // No framework found
    header('HTTP/1.0 500 Internal Server Error');
    exit('PSFS framework not found. Run composer install or check your PHAR build.');
}


// -----------------------------------------------------------------------------
// 3. Run the PSFS application
// -----------------------------------------------------------------------------

PSFS\Dispatcher::getInstance()->run();